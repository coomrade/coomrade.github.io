<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-hk">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="CTF,反序列化,SSRF," />










<meta name="description" content="昨天打了第四届上海市大学生网络安全大赛，这里记录下四道web的解题过程。 web1题目描述:what are you doing?这题说实话比较脑洞。。进来之后，页面没什么东西，注释有提示">
<meta name="keywords" content="CTF,反序列化,SSRF">
<meta property="og:type" content="article">
<meta property="og:title" content="第四届上海市大学生网络安全大赛-web">
<meta property="og:url" content="http://yoursite.com/2018/11/05/第四届上海市大学生网络安全大赛-web/index.html">
<meta property="og:site_name" content="C0mRaDe&#39;s Blog">
<meta property="og:description" content="昨天打了第四届上海市大学生网络安全大赛，这里记录下四道web的解题过程。 web1题目描述:what are you doing?这题说实话比较脑洞。。进来之后，页面没什么东西，注释有提示">
<meta property="og:locale" content="zh-hk">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541352876371.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541352909168.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541352950689.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541353058663.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541353214880.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541353294763.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541353386712.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541353505881.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541353572441.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541353653830.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541353718176.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541353802553.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541353889979.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541354126830.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541354210120.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541354871582.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541354929913.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541354974026.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541354999152.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541355257363.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541355424551.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541355463440.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541355572090.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541355828517.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541355852164.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541497692905.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541355942768.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541355988746.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541356012733.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541356167540.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541356380869.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541356404121.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541356584338.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541356798390.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541356853512.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541356886176.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541356969868.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541357022732.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541357082680.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541357198738.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541357353355.png">
<meta property="og:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541357778933.png">
<meta property="og:updated_time" content="2018-11-06T09:51:40.185Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="第四届上海市大学生网络安全大赛-web">
<meta name="twitter:description" content="昨天打了第四届上海市大学生网络安全大赛，这里记录下四道web的解题过程。 web1题目描述:what are you doing?这题说实话比较脑洞。。进来之后，页面没什么东西，注释有提示">
<meta name="twitter:image" content="https://www.github.com/coomrade/Img/raw/master/pics/1541352876371.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/11/05/第四届上海市大学生网络安全大赛-web/"/>





  <title>第四届上海市大学生网络安全大赛-web | C0mRaDe's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-hk">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">C0mRaDe's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">This is la vie en rose.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            歸檔
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/05/第四届上海市大学生网络安全大赛-web/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="C0mRaDe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/gabe-crow.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="C0mRaDe's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">第四届上海市大学生网络安全大赛-web</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              
              <time title="創建於" itemprop="dateCreated datePublished" datetime="2018-11-05T02:57:26+08:00">
                2018-11-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/信息安全/" itemprop="url" rel="index">
                    <span itemprop="name">信息安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>昨天打了第四届上海市大学生网络安全大赛，这里记录下四道web的解题过程。</p>
<h1 id="web1"><a href="#web1" class="headerlink" title="web1"></a>web1</h1><p>题目描述:what are you doing?<br>这题说实话比较脑洞。。<br>进来之后，页面没什么东西，注释有提示<a id="more"></a><img src="https://www.github.com/coomrade/Img/raw/master/pics/1541352876371.png" alt="enter description here"><code>robots.txt</code>：<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541352909168.png" alt="enter description here"><code>flag.php</code>应该是放flag的，直接看<code>source.php</code>有什么<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541352950689.png" alt="enter description here">还是注释有提示，根据注释，添加header:<code>X-Client-IP:127.0.0.1</code>以及post <code>admin=1</code>就可以看到下一步关键提示<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541353058663.png" alt="enter description here">按照提示post过去<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541353214880.png" alt="enter description here">给了一个图片的链接，访问一下发现是没东西的<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541353294763.png" alt="enter description here">一开始以为是要拼速度啥的，写了脚本，发现不是。回头再来看有没有被遗漏的点。发现url这个参数的解析符合<code>parse_url</code>的特征<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541353386712.png" alt="enter description here">可以看这篇<a href="https://paper.seebug.org/561/" target="_blank" rel="noopener">文章</a>对<code>parse_url</code>的特性讲解。从而想到有可能是SSRF，尝试一波<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541353505881.png" alt="enter description here">这里要想一下回显可能在哪里，自然地想到很可能就是在图片那了。访问图片，发现确实打到了东西<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541353572441.png" alt="enter description here">然后直接构造<code>url=file://@www.ichunqiu.com/var/www/html/flag.php</code>，再访问图片即可读到flag。<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541353653830.png" alt="enter description here"></p>
<h1 id="web2"><a href="#web2" class="headerlink" title="web2"></a>web2</h1><p>题目描述：Can you hack me?<br>进来之后同样是一个没东西的页面<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541353718176.png" alt="enter description here">这次注释也没东西，那么直接扫一波目录，发现有<code>.index.php.swp</code>，下载下来，用<code>vim -r</code>复原<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541353802553.png" alt="enter description here">所有代码如下:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">come</span></span>&#123;    </span><br><span class="line">    <span class="keyword">private</span> $method;</span><br><span class="line">    <span class="keyword">private</span> $args;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($method, $args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;method = $method;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;args = $args;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">$this</span>-&gt;args <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;args[$k] = <span class="keyword">$this</span>-&gt;waf(trim($v));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">waf</span><span class="params">($str)</span></span>&#123;</span><br><span class="line">        $str=preg_replace(<span class="string">"/[&lt;&gt;*;|?\n ]/"</span>,<span class="string">""</span>,$str);</span><br><span class="line">        $str=str_replace(<span class="string">'flag'</span>,<span class="string">''</span>,$str);</span><br><span class="line">        <span class="keyword">return</span> $str;</span><br><span class="line">    &#125;           </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">echo</span><span class="params">($host)</span></span>&#123;</span><br><span class="line">        system(<span class="string">"echo $host"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="keyword">$this</span>-&gt;method, <span class="keyword">array</span>(<span class="string">"echo"</span>))) &#123;</span><br><span class="line">            call_user_func_array(<span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="keyword">$this</span>-&gt;method), <span class="keyword">$this</span>-&gt;args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$first=<span class="string">'hi'</span>;</span><br><span class="line">$var=<span class="string">'var'</span>;</span><br><span class="line">$bbb=<span class="string">'bbb'</span>;</span><br><span class="line">$ccc=<span class="string">'ccc'</span>;</span><br><span class="line">$i=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">        <span class="keyword">if</span>($i===<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            $i++;</span><br><span class="line">            $$key = $value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;<span class="keyword">break</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($first===<span class="string">"doller"</span>)</span><br><span class="line">&#123;</span><br><span class="line">    @parse_str($_GET[<span class="string">'a'</span>]);</span><br><span class="line"><span class="keyword">if</span>($var===<span class="string">'give'</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>($bbb===<span class="string">'me'</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>($ccc===<span class="string">'flag'</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;br&gt;welcome&lt;/br&gt;"</span>;</span><br><span class="line">            $come=@$_POST[<span class="string">'come'</span>];</span><br><span class="line">            unserialize($come);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;br&gt;think about it&lt;/br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"no"</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"can you hack me?"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>前面是一个类的声明，然后看这个部分<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541353889979.png" alt="enter description here">它只能进行一次变量覆盖，我们看后面的代码，有一个<code>parse_str</code>，那时候再进行其它变量的覆盖也不迟，所以这里首先处理<code>$first</code>,传入<code>first=doller</code>，然后是一个<code>parse_str</code>，只需要把想改变值的变量传进a就可以了，注意<code>&amp;</code>要进行url编码，最终到达内层的<code>payload</code>是<code>first=doller&amp;a=var=give%26bbb=me%26ccc=flag</code><img src="https://www.github.com/coomrade/Img/raw/master/pics/1541354126830.png" alt="enter description here">然后就是一个反序列化，我们来看看这个类<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541354210120.png" alt="enter description here">首先可以看到，<code>__wakeup()</code>里面对<code>$args</code>进行了一个<code>foreach</code>的操作，每个<code>$v</code>都要进行<code>waf(trim($v))</code>的处理，这里很明显，<code>$args</code>得是一个数组。<br>然后再看，<code>waf</code>函数禁用了一些东西，但是好像本来就没打算用得上，还把flag替换为空，简单双写即可绕过。<br>再看<code>echo</code>函数，调用了<code>system()</code>，而且参数可控，明显可以命令注入。<br>最后看<code>__destruct</code>，这里限定了传进去的<code>$method</code>只能是<code>echo</code>，然后用<code>echo</code>函数对<code>$args</code>数组进行处理。<br>所以，我们可以这么构造<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541354871582.png" alt="enter description here">然后传入<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541354929913.png" alt="enter description here">再构造一次，读flag即可<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541354974026.png" alt="enter description here"><img src="https://www.github.com/coomrade/Img/raw/master/pics/1541354999152.png" alt="enter description here"></p>
<h1 id="web3"><a href="#web3" class="headerlink" title="web3"></a>web3</h1><p>题目描述：GOOD JOB<br>代码审计题<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">//error_reporting(0);</span></span><br><span class="line">    <span class="comment">//$dir=md5("icq" . $_SERVER['REMOTE_ADDR']);</span></span><br><span class="line">    $dir=md5(<span class="string">"icq"</span>);</span><br><span class="line">    $sandbox = <span class="string">'/var/sandbox/'</span> . $dir;</span><br><span class="line">    @mkdir($sandbox);</span><br><span class="line">    @chdir($sandbox);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>($_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>])&#123;</span><br><span class="line">        $filename = !<span class="keyword">empty</span>($_POST[<span class="string">'file'</span>]) ? $_POST[<span class="string">'file'</span>] : $_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>];</span><br><span class="line">        <span class="keyword">if</span> (!is_array($filename)) &#123;</span><br><span class="line">            $filename = explode(<span class="string">'.'</span>, $filename);</span><br><span class="line">        &#125;</span><br><span class="line">        $ext = end($filename);</span><br><span class="line">        <span class="keyword">if</span>($ext==$filename[count($filename) - <span class="number">1</span>])&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"emmmm..."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $new_name = (string)rand(<span class="number">100</span>,<span class="number">999</span>).<span class="string">"."</span>.$ext;</span><br><span class="line">        move_uploaded_file($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>],$new_name);</span><br><span class="line">        $_ = $_POST[<span class="string">'hehe'</span>];</span><br><span class="line">        <span class="keyword">if</span>(@substr(file($_)[<span class="number">0</span>],<span class="number">0</span>,<span class="number">6</span>)===<span class="string">'@&lt;?php'</span> &amp;&amp; strpos($_,$new_name)===<span class="keyword">false</span>)&#123;</span><br><span class="line">            <span class="keyword">include</span>($_);</span><br><span class="line">        &#125;</span><br><span class="line">        unlink($new_name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这题刚拿到手，还以为是今年HITCON的<code>one-line-php-challenge</code>的升级版，吓得我都打开了各种wp待命，后面仔细看了才发现其实没啥关系。首先我们需要绕过这个<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541355257363.png" alt="enter description here">这个东西，记性好的一秒钟就想到网鼎杯的那道上传题了，这里也一样，用数组即可绕过<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541355424551.png" alt="enter description here">然后再看下面的部分<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541355463440.png" alt="enter description here">这两行代码首先把文件名拼接，然后上传，这里通过构造拼接的文件名为<code>../../../../../../tmp/comrade.php</code>就可以把文件传到<code>/tmp</code>目录下。再看下面<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541355572090.png" alt="enter description here">这里首先限定了上传的文件开头6位必须是<code>@&lt;?php</code>，我们知道这文件内容现在是完全可控的，并没有什么实现难度，然后要求<code>$_</code>中不能有<code>$new_name</code>，这个也没什么难度。然后就<code>include($_)</code>了<br>我们知道，可以把文件传到<code>/tmp</code>目录下，然后这里<code>$_</code>又是可控的，事情就变得很简单了。像这样构造数据包<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541355828517.png" alt="enter description here">然后，读flag。<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541355852164.png" alt="enter description here"></p>
<h2 id="some-tricks"><a href="#some-tricks" class="headerlink" title="some tricks"></a>some tricks</h2><p>这里要注意的是，<code>move_uploaded_file</code>本身是有一定的容错性的，我把<code>new_name</code>打印出来看看：<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541497692905.png" alt="enter description here">在这个例子里，可以看到，<code>new_name</code>后面可以接若干个<code>/.</code>,最前面的<code>...../</code>可以用若干个<code>.</code>,而<code>unlink</code>的时候，文件名后面有<code>/.</code>是不行的~所以有时候可以躲过<code>unlink</code>，这题也可以，比如说不目录穿越，文件名后面加个<code>/.</code>，然后<code>unlink</code>失败，直接爆破<code>include</code>。</p>
<h1 id="web4"><a href="#web4" class="headerlink" title="web4"></a>web4</h1><p>题目描述：GOOD LUCK.</p>
<h2 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h2><p>进来之后有一个id输入框，还有个登录框<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541355942768.png" alt="enter description here">第一时间测测SQL注入，发现id是存在注入的。<code>id=sd&#39; or 1#</code>:<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541355988746.png" alt="enter description here"><code>id=sd&#39; or 0#</code>:<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541356012733.png" alt="enter description here">这里有个值得注意的地方，就是这句<code>$content=str_replace($value,&quot;&quot;,$content)</code>，很明显它在提示我们，后台很有可能把某些关键词替换为空了。fuzz一下，发现<code>load_file</code>和<code>union</code>和<code>information_schema.???</code>(手动测的)系列都被ban了<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541356167540.png" alt="enter description here">想了一下，觉得首先要找到它把什么替换为空了才能突破。进行了漫长的测试后，发现<code>from</code>和<code>select</code>都被替换为空。<code>id=sd&#39; or (selselectect 1)#</code>:<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541356380869.png" alt="enter description here"><code>id=sd&#39; or (selselectect 1 fromfromfrom)#</code>:<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541356404121.png" alt="enter description here">知道了这两个词被替换为空，那么能不能把他们插入到被ban的关键词中，从而实现绕过呢?<code>id=unifromon</code>:<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541356584338.png" alt="enter description here">没有报<code>get out hacker!!</code>，说明是可以的。然后进行注入，发现这是令人愉悦的有回显的注入(其实是后面才想起来，一开始完全就是当布尔盲注做的)<br><code>id=sd&#39; unifromon selselectect (seselectlect database()),2#</code>:<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541356798390.png" alt="enter description here"><code>id=sd&#39; unifromon selselectect (seselectlect group_concat(table_name)frfromom information_schemafrom.tables where table_schema=&#39;web&#39;),2#</code>:<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541356853512.png" alt="enter description here"><code>id=sd&#39; unifromon selselectect (seselectlect group_concat(column_name)frfromom information_schemafrom.columns where table_name=&#39;user&#39; and table_schema=&#39;web&#39;),2#</code>:<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541356886176.png" alt="enter description here"><code>id=sd&#39; unifromon selselectect (seselectlect group_concat(username,&#39;:&#39;,password)frfromom web.user),2#</code>:<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541356969868.png" alt="enter description here">注出<code>admin</code>的密码的md5，拿去解密<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541357022732.png" alt="enter description here">然后登录</p>
<h2 id="“文件上传”"><a href="#“文件上传”" class="headerlink" title="“文件上传”"></a>“文件上传”</h2><p>登录进来之后看到一个文件上传的表单<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541357082680.png" alt="enter description here">尝试传点东西，发现不能直接传php，看看数据包<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541357198738.png" alt="enter description here">发现无论传过去的文件名是什么，后台都会在最后面加个<code>.txt</code>，而且提示说要<code>upload to ./flag.php</code>，而且这是个假的上传，访问返回的链接是没有东西的。这里首先发现，最终的文件名是<code>uploaddir</code>和<code>fileField</code>的文件名共同组成的，两者配合可以弄出一个php的后缀。<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541357353355.png" alt="enter description here">剩下的问题就只有如何去掉这个<code>.txt</code>，第一感觉当然就是截断了，尝试了#,00截断都不行。卡住了好久好久，甚至回到sql注入那里看看能不能<code>load_file</code>读读后台到底是怎么写的，但是不行。最后还是觉得要截断，试了几个常见的，<code>%0a,%09</code>，都不行，实在是没办法了，打算把不可见字符都试一遍，试到<code>%02</code>的时候，成了。??<img src="https://www.github.com/coomrade/Img/raw/master/pics/1541357778933.png" alt="enter description here"></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/CTF/" rel="tag"># CTF</a>
          
            <a href="/tags/反序列化/" rel="tag"># 反序列化</a>
          
            <a href="/tags/SSRF/" rel="tag"># SSRF</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/10/30/secconctf2018-GHOSTKINGDOM/" rel="next" title="SECCONCTF2018-GhostKingdom">
                <i class="fa fa-chevron-left"></i> SECCONCTF2018-GhostKingdom
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/11/05/XCTF2018-Final-bestphp/" rel="prev" title="XCTF2018-Final_bestphp">
                XCTF2018-Final_bestphp <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            本站概覽
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/gabe-crow.jpg"
                alt="C0mRaDe" />
            
              <p class="site-author-name" itemprop="name">C0mRaDe</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">31</span>
                  <span class="site-state-item-name">文章</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">分類</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">24</span>
                  <span class="site-state-item-name">標籤</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#web1"><span class="nav-number">1.</span> <span class="nav-text">web1</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#web2"><span class="nav-number">2.</span> <span class="nav-text">web2</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#web3"><span class="nav-number">3.</span> <span class="nav-text">web3</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#some-tricks"><span class="nav-number">3.1.</span> <span class="nav-text">some tricks</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#web4"><span class="nav-number">4.</span> <span class="nav-text">web4</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SQL注入"><span class="nav-number">4.1.</span> <span class="nav-text">SQL注入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#“文件上传”"><span class="nav-number">4.2.</span> <span class="nav-text">“文件上传”</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">C0mRaDe</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
